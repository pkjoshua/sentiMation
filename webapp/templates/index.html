{% extends "base.html" %}

{% block title %}SentiMation - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
            </h1>
            <a href="{{ url_for('schedule_generation') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                Schedule New Generation
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Tasks</h6>
                        <h3 class="mb-0" id="total-tasks">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pending</h6>
                        <h3 class="mb-0" id="pending-tasks">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Completed</h6>
                        <h3 class="mb-0" id="completed-tasks">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Failed</h6>
                        <h3 class="mb-0" id="failed-tasks">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Scheduled Tasks
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tasks-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Generator</th>
                                <th>Prompt</th>
                                <th>Schedule</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-tbody">
                            <!-- Tasks will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-tasks" class="text-center py-4" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No tasks scheduled</h5>
                    <p class="text-muted">Get started by scheduling your first generation task.</p>
                    <a href="{{ url_for('schedule_generation') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Schedule Task
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="task-modal-body">
                <!-- Task details will be loaded here -->
            </div>
            <div class="modal-footer" id="task-modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    
    // Refresh tasks every 30 seconds
    setInterval(loadTasks, 30000);
});

function loadTasks() {
    fetch('/tasks')
        .then(response => response.json())
        .then(tasks => {
            updateDashboardStats(tasks);
            updateTasksTable(tasks);
        })
        .catch(error => {
            console.error('Error loading tasks:', error);
        });
}

function updateDashboardStats(tasks) {
    const total = tasks.length;
    const pending = tasks.filter(t => t.status === 'pending').length;
    const completed = tasks.filter(t => t.status === 'completed').length;
    const failed = tasks.filter(t => t.status === 'failed').length;
    
    document.getElementById('total-tasks').textContent = total;
    document.getElementById('pending-tasks').textContent = pending;
    document.getElementById('completed-tasks').textContent = completed;
    document.getElementById('failed-tasks').textContent = failed;
}

function updateTasksTable(tasks) {
    const tbody = document.getElementById('tasks-tbody');
    const noTasks = document.getElementById('no-tasks');
    
    if (tasks.length === 0) {
        tbody.innerHTML = '';
        noTasks.style.display = 'block';
        return;
    }
    
    noTasks.style.display = 'none';
    
    tbody.innerHTML = tasks.map(task => `
        <tr>
            <td><code>${task.id}</code></td>
            <td>
                <span class="badge bg-info">
                    <i class="fas fa-cog me-1"></i>
                    ${task.generator_type}
                </span>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${task.prompt}">
                    ${task.prompt === 'RANDOM_ACTIVITY' ? 'ðŸŽ² Random Activity' : task.prompt}
                </div>
            </td>
            <td>${formatSchedule(task)}</td>
            <td>${getStatusBadge(task.status)}</td>
            <td>${formatDateTime(task.created_at)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewTask('${task.id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${task.status === 'pending' ? `
                        <button class="btn btn-outline-success" onclick="runTaskNow('${task.id}')" title="Run Now">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="cancelTask('${task.id}')" title="Cancel Task">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pending</span>',
        'running': '<span class="badge bg-info"><i class="fas fa-spinner fa-spin me-1"></i>Running</span>',
        'completed': '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>',
        'failed': '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Failed</span>',
        'cancelled': '<span class="badge bg-secondary"><i class="fas fa-ban me-1"></i>Cancelled</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    return date.toLocaleString();
}

function formatSchedule(task) {
    if (task.is_recurring) {
        const days = task.recurring_days.map(day => day.charAt(0).toUpperCase() + day.slice(1)).join(', ');
        return `<span class="badge bg-info"><i class="fas fa-redo me-1"></i>${days} at ${task.recurring_time}</span>`;
    } else {
        return formatDateTime(task.scheduled_time);
    }
}

function viewTask(taskId) {
    fetch(`/task/${taskId}`)
        .then(response => response.json())
        .then(task => {
            const modalBody = document.getElementById('task-modal-body');
            const modalFooter = document.getElementById('task-modal-footer');
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Task Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td><code>${task.id}</code></td></tr>
                            <tr><td><strong>Generator:</strong></td><td>${task.generator_type}</td></tr>
                            <tr><td><strong>Status:</strong></td><td>${getStatusBadge(task.status)}</td></tr>
                            <tr><td><strong>Scheduled:</strong></td><td>${formatDateTime(task.scheduled_time)}</td></tr>
                            <tr><td><strong>Created:</strong></td><td>${formatDateTime(task.created_at)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Prompt</h6>
                        <div class="alert alert-light">
                            ${task.prompt === 'RANDOM_ACTIVITY' ? 'ðŸŽ² Random Activity (will be selected when task runs)' : task.prompt}
                        </div>
                        ${task.is_recurring ? `
                            <h6>Recurring Schedule</h6>
                            <div class="alert alert-info">
                                <strong>Days:</strong> ${task.recurring_days.map(day => day.charAt(0).toUpperCase() + day.slice(1)).join(', ')}<br>
                                <strong>Time:</strong> ${task.recurring_time}
                            </div>
                        ` : ''}
                        ${task.error_message ? `
                            <h6>Error Message</h6>
                            <div class="alert alert-danger">
                                ${task.error_message}
                            </div>
                        ` : ''}
                    </div>
                </div>
                ${task.result_path ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Generated Video</h6>
                            <video controls class="w-100" style="max-height: 400px;">
                                <source src="/static/generated/${task.result_path.split('/').pop()}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="mt-2">
                                <a href="/static/generated/${task.result_path.split('/').pop()}" 
                                   class="btn btn-sm btn-outline-primary" download>
                                    <i class="fas fa-download me-1"></i>
                                    Download Video
                                </a>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Update modal footer with action buttons
            if (task.status === 'pending') {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-success me-2" onclick="runTaskNow('${task.id}'); bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();">
                        <i class="fas fa-play me-1"></i>
                        Run Now
                    </button>
                    <button type="button" class="btn btn-danger me-2" onclick="cancelTask('${task.id}'); bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();">
                        <i class="fas fa-times me-1"></i>
                        Cancel Task
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            } else {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading task details:', error);
            alert('Error loading task details');
        });
}

function cancelTask(taskId) {
    if (confirm('Are you sure you want to cancel this task?')) {
        fetch(`/cancel/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Task cancelled successfully');
                    loadTasks();
                }
            })
            .catch(error => {
                console.error('Error cancelling task:', error);
                alert('Error cancelling task');
            });
    }
}

function runTaskNow(taskId) {
    if (confirm('Are you sure you want to run this task immediately?')) {
        fetch(`/run_now/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Task started successfully!');
                    loadTasks();
                }
            })
            .catch(error => {
                console.error('Error running task:', error);
                alert('Error running task');
            });
    }
}
</script>
{% endblock %} 